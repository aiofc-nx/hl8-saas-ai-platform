# HL8-SaaS 平台业务需求文档 - 认证模块

> **文档说明**：本文档采用逐步完善的策略，当前版本仅涵盖认证模块的核心功能。后续版本将逐步补充其他业务模块的需求。

## 版本历史

| 版本 | 日期    | 作者 | 说明                                                 |
| ---- | ------- | ---- | ---------------------------------------------------- |
| v1.0 | 2024-12 | -    | 初始版本，包含用户注册、邮箱验证、用户登录、用户登出 |

---

## 1. 用户注册

### 1.1 业务规则

#### 1.1.1 注册信息要求

- **邮箱地址（必填）**
  - 必须是有效的邮箱格式
  - 邮箱地址在系统中必须唯一
  - 系统会自动从邮箱地址中提取用户名（@ 符号前的部分）

- **密码（必填）**
  - 密码长度至少 8 个字符
  - 必须包含至少一个大写字母
  - 必须包含至少一个数字
  - 必须包含至少一个特殊字符（如：`!@#$%^&*(),.?":{}|<>`）

#### 1.1.2 唯一性约束

- 系统在注册时会检查邮箱和用户名的唯一性
- 如果邮箱或用户名已存在，注册将失败并返回错误提示
- 错误信息：`"用户名或邮箱已存在"`

#### 1.1.3 初始状态

- 新注册的用户账户处于**未验证邮箱**状态
- 用户账户创建成功后，系统会自动生成邮箱验证码（OTP）
- 用户必须完成邮箱验证后才能正常使用系统的核心功能

### 1.2 业务逻辑

#### 1.2.1 用户账户创建流程

1. **输入验证**
   - 验证邮箱格式
   - 验证密码强度
   - 检查邮箱和用户名是否已存在

2. **数据准备**
   - 从邮箱地址提取用户名（例如：`user@example.com` → 用户名：`user`）
   - 使用加密算法对密码进行哈希处理（密码以加密形式存储，系统无法获取明文密码）
   - 生成 6 位数字的邮箱验证码（OTP）
   - 设置验证码过期时间为 24 小时

3. **数据库事务操作**（原子性保证）
   - 创建用户记录
     - 保存邮箱、用户名、加密后的密码
     - 设置邮箱验证状态为未验证（`isEmailVerified = false`）
   - 创建用户个人资料记录
     - 从邮箱地址提取姓名（默认使用用户名）
     - 建立用户与个人资料的关联
   - 创建邮箱验证码（OTP）记录
     - 保存验证码
     - 标记验证码类型为邮箱确认（`EMAIL_CONFIRMATION`）
     - 设置过期时间

4. **邮件发送**
   - 系统向用户注册邮箱发送验证邮件
   - 邮件包含：
     - 欢迎信息
     - 6 位数字验证码
     - 验证码过期时间提示
   - **邮件发送失败不影响用户注册成功**（系统会记录错误日志，但用户账户已创建）

5. **开发环境支持**
   - 在非生产环境中，验证码会在控制台输出，方便开发调试

### 1.3 业务流程

```
用户提交注册信息
    ↓
系统验证邮箱格式和密码强度
    ↓
系统检查邮箱和用户名是否已存在
    ├─ 已存在 → 返回错误："用户名或邮箱已存在"
    └─ 不存在 → 继续
    ↓
系统开始数据库事务
    ├─ 创建用户记录（邮箱、用户名、加密密码）
    ├─ 创建个人资料记录
    └─ 生成并保存邮箱验证码（24小时有效）
    ↓
事务提交
    ↓
发送验证邮件（异步，失败不影响注册）
    ↓
返回注册成功消息
    ↓
用户收到验证邮件（包含验证码）
    ↓
【分支路径】
    ├─ 用户在24小时内验证 → 验证成功，账户激活
    └─ 用户未在24小时内验证 → 验证码过期
        ↓
        用户需要重新请求验证邮件（见 2.4 和 2.5 节）
```

### 1.4 异常处理

- **邮箱或用户名已存在**
  - 错误码：`USER_ALREADY_EXISTS`
  - 错误信息：`"用户名或邮箱已存在"`

- **邮件发送失败**
  - 系统记录错误日志
  - 用户注册仍然成功
  - 用户可以通过"重新发送验证邮件"功能获取验证码

- **数据库操作失败**
  - 错误码：`USER_CREATION_FAILED` 或 `REGISTRATION_FAILED`
  - 错误信息：`"注册失败，请稍后重试"`

### 1.5 未验证邮箱用户的后续处理

#### 1.5.1 用户注册后的状态

- **账户已创建但未激活**
  - 用户账户已成功创建，可以正常登录系统
  - 但账户处于**未验证邮箱**状态（`isEmailVerified = false`）
  - 用户无法访问系统的核心功能，系统会强制用户进行邮箱验证

#### 1.5.2 验证码有效期

- **首次验证码**
  - 注册时自动生成的验证码有效期为 **24 小时**
  - 如果用户在 24 小时内未验证，验证码将失效

- **验证码过期后的处理**
  - 验证码过期后，用户无法使用过期验证码完成验证
  - 系统会返回错误：`"验证码已过期，请重新获取"`
  - 用户需要重新请求发送验证邮件（详见 2.4 节）

#### 1.5.3 未验证邮箱用户的系统访问限制

- **访问控制规则**
  - 未验证邮箱的用户可以登录系统
  - 登录后，系统会自动重定向到邮箱确认页面（`/auth/confirm-email`）
  - 用户无法访问系统的其他受保护路由（首页、个人中心等）
  - 用户只能停留在邮箱确认页面，直到完成邮箱验证

- **功能限制**
  - 未验证邮箱的用户无法使用系统的核心业务功能
  - 只能进行以下操作：
    - 查看邮箱确认页面
    - 输入验证码完成验证
    - 请求重新发送验证邮件

#### 1.5.4 长期未验证的处理策略

- **无强制验证期限**
  - 系统**不会**自动删除长期未验证邮箱的用户账户
  - 用户账户可以永久保持未验证状态
  - 系统允许用户随时验证邮箱，没有时间限制

- **重新发送验证邮件**
  - 用户可以**无限次**请求重新发送验证邮件
  - 每次重新发送都会：
    - 删除旧的验证码
    - 生成新的 6 位数字验证码
    - 设置新的 24 小时有效期
    - 发送包含新验证码的邮件

- **验证码获取方式**
  - 通过邮箱接收验证邮件（推荐方式）
  - 在开发环境中，验证码会在控制台输出，方便开发调试

#### 1.5.5 用户主动验证的流程

用户可以通过以下方式完成邮箱验证：

1. **使用注册时的验证码**
   - 如果在 24 小时内，直接使用注册邮件中的验证码

2. **重新请求验证邮件**
   - 验证码过期后，在登录页或邮箱确认页面请求重新发送
   - 系统会发送新的验证码邮件

3. **使用新验证码完成验证**
   - 在邮箱确认页面输入新的验证码
   - 验证成功后自动登录并解锁系统功能

---

## 2. 邮箱验证

### 2.1 业务规则

#### 2.1.1 验证码要求

- 验证码为 6 位数字字符串
- 验证码在注册时自动生成并发送到用户邮箱
- 验证码有效期为 **24 小时**
- 验证码类型为 `EMAIL_CONFIRMATION`（邮箱确认类型）

#### 2.1.2 验证前置条件

- 用户必须已完成注册
- 用户邮箱必须处于未验证状态
- 验证码必须存在且未过期

#### 2.1.3 验证成功后的状态变更

- 用户邮箱验证状态更新为已验证（`isEmailVerified = true`）
- 记录邮箱验证时间（`emailVerifiedAt`）
- 验证码在使用后立即失效并删除
- **自动为用户创建登录会话**，用户无需再次登录

### 2.2 业务逻辑

#### 2.2.1 邮箱验证流程

1. **输入验证**
   - 验证邮箱格式
   - 验证验证码格式（必须是 6 位字符串）

2. **用户验证**
   - 根据邮箱查找用户
   - 如果用户不存在，返回错误：`"用户不存在"`

3. **验证码验证**
   - 在系统中查找对应的邮箱确认验证码
   - 检查验证码是否存在
   - 检查验证码是否匹配
   - 检查验证码是否已过期（当前时间 > 过期时间）

4. **状态更新**（数据库事务）
   - 更新用户邮箱验证状态为已验证
   - 记录邮箱验证时间
   - 删除已使用的验证码

5. **自动登录**
   - 生成访问令牌（Access Token）和刷新令牌（Refresh Token）
   - 创建用户登录会话
   - 返回用户信息和令牌，用户可直接使用系统

6. **通知邮件**
   - 向用户发送邮箱验证成功确认邮件

### 2.3 业务流程

```
用户输入邮箱和验证码
    ↓
系统验证邮箱格式和验证码格式
    ↓
系统查找用户
    ├─ 不存在 → 返回错误："用户不存在"
    └─ 存在 → 继续
    ↓
系统查找验证码
    ├─ 不存在 → 返回错误："验证码不存在或已失效"
    ├─ 不匹配 → 返回错误："验证码不正确"
    ├─ 已过期 → 返回错误："验证码已过期"
    └─ 有效 → 继续
    ↓
系统更新用户状态（邮箱已验证）
    ↓
系统删除验证码
    ↓
系统生成访问令牌和刷新令牌
    ↓
系统创建登录会话
    ↓
发送验证成功邮件（异步）
    ↓
返回用户信息和令牌（用户自动登录）
```

### 2.4 验证码过期后的处理

#### 2.4.1 验证码过期场景

- **过期原因**
  - 用户注册后 24 小时内未完成验证
  - 用户收到验证码后长时间未使用（超过 24 小时）

- **过期后的影响**
  - 过期的验证码无法用于邮箱验证
  - 系统会返回错误：`"验证码已过期，请重新获取"`
  - 用户无法使用过期验证码完成验证

#### 2.4.2 验证码过期后的解决方案

用户需要重新获取验证码才能完成验证：

1. **通过邮箱确认页面**
   - 用户在登录后会自动跳转到邮箱确认页面
   - 页面提供"重新发送验证邮件"功能

2. **通过登录页面**
   - 未登录用户可以在登录页面找到"重新发送验证邮件"的入口

3. **重新发送验证邮件**
   - 用户提供注册时使用的邮箱地址
   - 系统生成新的验证码（24 小时有效）
   - 发送包含新验证码的邮件

---

### 2.5 重新发送验证邮件

#### 2.5.1 业务规则

- **适用场景**
  - 验证码过期后需要重新获取
  - 用户未收到验证邮件
  - 用户误删验证邮件

- **使用限制**
  - 用户可以**无限次**请求重新发送验证邮件
  - 仅对未验证邮箱的用户生效
  - 已验证邮箱的用户无法使用此功能

- **验证码管理**
  - 系统会生成新的验证码并发送
  - 旧的验证码会被删除（确保每个用户只有一个有效的邮箱验证码）
  - 新验证码的有效期重新计算为 24 小时

#### 2.5.2 业务流程

```
用户请求重新发送验证邮件（提供邮箱地址）
    ↓
系统查找用户
    ├─ 不存在 → 返回错误："用户不存在"
    └─ 存在 → 继续
    ↓
系统检查邮箱是否已验证
    ├─ 已验证 → 返回错误："邮箱已验证，无需重复验证"
    └─ 未验证 → 继续
    ↓
系统删除旧的邮箱确认验证码
    ↓
系统生成新的验证码（24小时有效）
    ↓
系统保存新验证码
    ↓
发送验证邮件（包含新验证码）
    ↓
返回成功消息
```

### 2.6 异常处理

- **用户不存在**
  - 错误码：`USER_NOT_FOUND`
  - 错误信息：`"用户不存在"`

- **验证码不存在或已失效**
  - 错误码：`INVALID_CONFIRMATION_CODE`
  - 错误信息：`"验证码不存在或已失效"`

- **验证码不正确**
  - 错误码：`INVALID_CONFIRMATION_CODE`
  - 错误信息：`"验证码不正确，请检查后重试"`

- **验证码已过期**
  - 错误码：`CONFIRMATION_CODE_EXPIRED`
  - 错误信息：`"验证码已过期，请重新获取"`

- **邮箱已验证**（重新发送验证邮件时）
  - 错误码：`EMAIL_ALREADY_VERIFIED`
  - 错误信息：`"邮箱已验证，无需重复验证"`

---

## 3. 用户登录

### 3.0 登录权限说明

**重要：未激活（未验证邮箱）的用户可以登录系统**

- **已注册但未验证邮箱的用户（未激活状态）可以正常登录**
  - 系统不阻止未验证邮箱的用户登录
  - 登录时仅验证用户名/邮箱和密码的正确性
  - 不检查邮箱验证状态作为登录的前置条件

- **登录后的行为差异**
  - **已验证邮箱的用户**：登录成功后重定向到首页，可以正常使用系统功能
  - **未验证邮箱的用户**：登录成功后自动重定向到邮箱确认页面（`/auth/confirm-email`），只能在此页面进行操作，无法访问其他功能

- **设计原因**
  - 允许用户在验证码过期后通过登录重新进入系统并重新请求验证邮件
  - 提升用户体验，避免因验证邮件丢失而无法完成验证的情况
  - 通过前端路由控制而非后端拦截，保持登录流程的统一性

### 3.1 业务规则

#### 3.1.1 登录凭证要求

- **标识符（必填）**
  - 可以是邮箱地址或用户名
  - 系统支持使用任一方式登录

- **密码（必填）**
  - 必须与注册时设置的密码匹配
  - 系统会使用加密算法验证密码

#### 3.1.2 登录行为规则

- **邮箱验证状态不影响登录**
  - 未验证邮箱的用户也可以登录
  - 但系统会根据邮箱验证状态进行路由重定向
  - 未验证邮箱的用户登录后会被重定向到邮箱确认页面

- **会话管理**
  - 每次登录都会创建新的会话记录
  - 会话记录包含设备信息（IP 地址、设备名称、操作系统、浏览器、地理位置等）
  - 用户可以在多个设备上同时保持登录状态

#### 3.1.3 令牌机制

- **访问令牌（Access Token）**
  - 包含用户基本信息（用户名、邮箱、用户ID）
  - 用于身份认证和授权
  - 具有较短的过期时间

- **刷新令牌（Refresh Token）**
  - 包含用户基本信息（用户名、邮箱、用户ID）
  - 用于刷新访问令牌
  - 具有较长的过期时间
  - 与会话绑定，存储在会话记录中

- **会话令牌（Session Token）**
  - 会话的唯一标识符（UUID）
  - 用于标识和管理用户会话

### 3.2 业务逻辑

#### 3.2.1 用户登录流程

1. **凭证验证**
   - 系统根据标识符（邮箱或用户名）查找用户
   - 如果用户不存在，返回错误：`"用户名或密码错误"`（不暴露用户是否存在）
   - 系统使用加密算法验证密码
   - 如果密码不正确，返回错误：`"用户名或密码错误"`

2. **令牌生成**
   - 生成访问令牌（Access Token）
   - 生成刷新令牌（Refresh Token）
   - 两个令牌包含相同的用户信息但使用不同的密钥和过期时间

3. **会话创建**
   - 创建会话记录
   - 关联用户和刷新令牌
   - 记录设备信息（IP、设备名称、操作系统、浏览器、地理位置、User Agent 等）

4. **通知邮件**
   - 向用户发送登录成功通知邮件
   - 邮件包含登录时间、IP 地址、地理位置、设备信息
   - **邮件发送失败不影响登录成功**

5. **返回结果**
   - 返回用户信息（排除敏感字段如密码）
   - 返回访问令牌、刷新令牌、会话令牌
   - 返回会话刷新时间

### 3.3 业务流程

```
用户提交登录凭证（标识符 + 密码）
    ↓
系统根据标识符查找用户
    ├─ 不存在 → 返回错误："用户名或密码错误"
    └─ 存在 → 继续
    ↓
系统验证密码
    ├─ 不正确 → 返回错误："用户名或密码错误"
    └─ 正确 → 继续（**不检查邮箱验证状态，允许未激活用户登录**）
    ↓
系统生成访问令牌和刷新令牌
    ↓
系统创建会话记录（记录设备信息）
    ↓
发送登录成功通知邮件（异步，失败不影响登录）
    ↓
返回用户信息和令牌
    ↓
前端根据邮箱验证状态进行路由
    ├─ 未验证邮箱 → 重定向到邮箱确认页面
    └─ 已验证邮箱 → 重定向到首页
```

### 3.4 访问控制规则

#### 3.4.1 未认证用户

- 访问受保护的路由时，自动重定向到登录页面（`/auth/sign-in`）
- 静态资源（如 `/assets`、`/favicon.ico`）允许无限制访问

#### 3.4.2 已认证但未验证邮箱的用户

- 访问任何路由时，自动重定向到邮箱确认页面（`/auth/confirm-email`）
- 已在邮箱确认页面的用户可以继续停留在该页面

#### 3.4.3 已认证且已验证邮箱的用户

- 可以正常访问所有授权路由
- 访问登录页面时，自动重定向到首页（避免重复登录）

### 3.5 异常处理

- **用户不存在或密码错误**
  - 错误码：`INVALID_CREDENTIALS`
  - 错误信息：`"用户名或密码错误"`（统一错误提示，不暴露用户是否存在）

- **邮件发送失败**
  - 系统记录警告日志
  - 登录仍然成功
  - 用户可正常使用系统

---

## 4. 用户登出

### 4.1 业务规则

#### 4.1.1 登出范围

- **单设备登出**
  - 用户可以登出当前设备
  - 仅删除当前设备的会话记录
  - 其他设备的会话仍然有效，用户可以在其他设备上继续使用系统

- **全设备登出**
  - 用户可以登出所有设备
  - 删除用户在所有设备上的所有会话记录
  - 所有设备的刷新令牌都会失效

#### 4.1.2 会话管理

- 登出操作通过会话令牌（Session Token）标识要删除的会话
- 会话删除后，对应的刷新令牌立即失效
- 访问令牌在过期前仍可能有效，但由于刷新令牌已失效，无法刷新访问令牌

### 4.2 业务逻辑

#### 4.2.1 单设备登出流程

1. **会话验证**
   - 根据会话令牌查找会话记录
   - 如果会话不存在，返回错误：`"会话不存在"`

2. **会话删除**
   - 删除会话记录（级联删除相关的刷新令牌关联）
   - 会话删除后，该设备的刷新令牌失效

3. **返回结果**
   - 返回登出成功消息

#### 4.2.2 全设备登出流程

1. **用户验证**
   - 根据用户ID查找所有会话记录
   - 如果用户不存在会话，操作仍然成功（静默处理）

2. **批量删除**
   - 删除用户的所有会话记录
   - 所有设备的刷新令牌失效

3. **返回结果**
   - 返回登出成功消息

### 4.3 业务流程

#### 4.3.1 单设备登出

```
用户发起登出请求（提供会话令牌）
    ↓
系统根据会话令牌查找会话
    ├─ 不存在 → 返回错误："会话不存在"
    └─ 存在 → 继续
    ↓
系统删除会话记录
    ↓
刷新令牌失效（无法再刷新访问令牌）
    ↓
返回登出成功消息
```

#### 4.3.2 全设备登出

```
用户发起全设备登出请求（提供用户ID）
    ↓
系统查找用户的所有会话记录
    ↓
系统批量删除所有会话记录
    ↓
所有设备的刷新令牌失效
    ↓
返回登出成功消息
```

### 4.4 异常处理

- **会话不存在**（单设备登出时）
  - 错误码：`SESSION_NOT_FOUND`
  - 错误信息：`"会话不存在"`

---

## 5. 会话管理

### 5.1 业务规则

#### 5.1.1 会话生命周期

- 会话在用户登录时创建
- 会话在用户登出时删除
- 会话在用户从所有设备登出时批量删除

#### 5.1.2 会话信息

每个会话记录包含以下信息：

- **用户关联**：关联的用户账户
- **刷新令牌**：用于刷新访问令牌的令牌
- **设备信息**：
  - IP 地址
  - 设备名称
  - 设备操作系统
  - 浏览器类型
  - 地理位置
  - User Agent 字符串
- **时间戳**：会话创建时间

#### 5.1.3 会话查询

- 用户可以查询自己在所有设备上的活动会话
- 用户可以查询单个会话的详细信息
- 查询功能仅对已认证用户开放

### 5.2 业务逻辑

#### 5.2.1 查询所有会话

- 根据用户ID查找该用户的所有会话记录
- 返回会话列表（包含设备信息）

#### 5.2.2 查询单个会话

- 根据会话ID查找会话记录
- 如果会话不存在，返回错误：`"会话不存在"`

---

## 6. 安全考虑

### 6.1 密码安全

- 密码使用加密算法存储，系统无法获取明文密码
- 密码验证使用安全的比较算法
- 密码强度要求强制执行

### 6.2 令牌安全

- 访问令牌和刷新令牌使用不同的密钥
- 令牌包含用户信息但使用签名保证完整性
- 令牌有过期时间限制

### 6.3 验证码安全

- 验证码随机生成
- 验证码有过期时间（24小时）
- 验证码使用后立即删除
- 错误信息不暴露验证码的存在性

### 6.4 会话安全

- 会话令牌使用 UUID，难以猜测
- 会话与设备信息绑定，便于异常检测
- 支持用户主动管理会话（查看、登出）

### 6.5 错误信息

- 统一错误信息，避免信息泄露
- 例如：登录时，无论用户不存在还是密码错误，都返回相同的错误信息

---

## 7. 后续计划

本文档将逐步完善，后续版本计划包含：

- [ ] 密码重置功能
- [ ] 密码修改功能
- [ ] 账户删除功能
- [ ] 令牌刷新机制
- [ ] 第三方登录（如微信登录）
- [ ] 多因素认证（MFA）
- [ ] 账户锁定机制
- [ ] 登录历史记录

---

**文档维护说明**：本文档基于当前代码实现整理，如代码实现发生变化，应及时更新本文档以保持一致性。
